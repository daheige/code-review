# 工程师该如何做code review

作为一名战斗在一线11年以上的工程师，我review过很多code，也看过很多别人的review评论。这些年，我发现不少同学在code review和写出“好味道”的代码的水平有待提升。今天，我就分享一下我在code review的一些思想和理念。

# 为什么要做code review？
发现坏味道的实践，就是Code Review：对计算机源代码系统化地审查，常用软件同行评审的方式进行，其目的是在找出及修正在软件开发初期未发现的错误，提升软件质量及开发者的技术。团队对 CR本身的理解有差异，有的团队：
- 在一个完整的开发周期结束之后，做一次code review
- 每周一次code review
- 每天都要code review

其实，code review是团队或者个人持续沟通协作、反馈的过程。
- 没人保证自己写出来的代码没问题，而规避个体问题的主要方式就是使用集体智慧，团队的力量，这是从个体的角度在看问题。
- 看待CR还有一个团队视角：CR的过程，也是一个知识分享，保证一些细节的知识或者接口设计、抽象设计等，不再是隐藏在某一个人的头脑中，而是摆在团队面前，非常直观明了。
无论是从哪个角度看CR，它的本质，就是沟通反馈的过程。把对这段代码的理解分享给你，你把你对这段代码的想法共享给我。有人给出代码实现的知识，有人贡献技术理解。如果我们理解了CR是个沟通反馈的过程，那就可以把沟通反馈的一些原则运用到CR。
沟通反馈，希望沟通要尽可能透明、及时。把这样的理解放到CR中，就是要尽可能多暴露问题，尽可能多做CR。

# 开发人员或主管都需要做code review吗？
有句话是："Talk is cheap,show me your code"。这句话，非常清晰地告诉我们，话从嘴里讲出来，相对比较轻松，或者说把别人说过的话，用自己的语言组织下，再说出来，比较容易。但是，在写代码，做工程设计，想要做到知行合一，是比较难的。有时候，我们可能会道听途说一些不成文的规定，或者谬论，或者一些网上的博客，文章，就以为自己掌握了精髓，其实不然。有时候，我们有能力去思考，或是改善自己当前设计的代码，或是做一些底层细节上的抽象设计，改善下代码运行的方式吗？毫不夸张地说，很多人压根不知道如何写出地道、简洁的代码，或者说过度自信自己写的代码，就如天龙八部的降龙十八掌一样厉害，进而产生一种虚假的心理安全感————自己的代码写的并不烂，不糟糕。但是，他并没有按照代码规范来编写代码，更不要说遵循《架构整洁之道》或是《重构————改善既有代码的设计与结构》的一些方法论和设计原则。从实践结果来说，他根本不懂这些方法论和实践原则。

在我看来，代码是最能体现一个工程师设计理念、思维方式落地的地方，因为它是业务逻辑或技术组件库的呈现和根本。我们可以在code review过程中，做到落地沟通，而不是空对空的，你一句，我一句的讨论。其实，通过code review，开发人员，可以在实际问题中产生思想的碰撞与摩擦，相互之间学习和交流。对于到团地中，就是适合团队、恰如其分的最佳实践方式！如果说，一个团队的leader没有时间去编写代码，仅仅是code review代码时候，指出别人的代码这里不对，那里设计有问题。有时候，在一些开发人员看来，德不配位。也有另一种观点，即使没有亲手写代码，在做code review时，如果能给出良好的、有建设性的意见时，也是对最佳实践做了一些思考和权衡的。

# 开发人员可以在code review中思考和总结经验吗？
首先，我给一个自己做的总结：作为团队的架构师或技术经理，需要掌握大量的设计理念、方法论和原则，在一线亲自战斗过，并且知道不同语言以及工具链或生态的发展和实践方法。或者说是对不同业务需求的理解，能定制化框架开发或工程实践等，甚至能根据不同语言的编程范式，写出符合业务逻辑或组件库的代码。进而控制在积累到一定代码量时候，能进一步考虑开发的便利性、可读性、可维护性、可拓展性、可测试性，做到简洁且漂亮，或是《unix编程艺术》中提到的KISS原则，真正做到编写的代码在软件需求变更时，具有一定的可修改性和灵活性。

真正厉害的技术大佬，可以分为以下几类：
- 奇技淫巧。这种分两种人，一种真正的大师，例如GO语言的dave(pkg/errors的作者)，对所写的GO项目做了大量极致的优化；另一种就是，掌握了很多技巧，建立在一些黑魔法，黑科技的思路之上的，可能暂时能解决问题，实际上长时间可能不管用，用处不大，跟前者相比，就相当于是在炫技。这里得强调一点，代码是写給人看的，我们尽量不要炫技，不然后面维护的人，会对你各种谩骂或是吐槽，设计的真烂。
- 出神入化。例如：Linux 之父 Linus Torvalds：低调的神话创造者。在Linux内核设计时，能把C语言的各种数据结构，指针用得出神入化。他长期以来，对C++做了各种炮轰，语言相当犀利。
- 领域先行者。约翰·卡马克，他创造出了现代计算机图形高效渲染的方法论。如果没有他，后面会不会有人发明，这个很难说。1999年，卡马克登上了美国时代杂志评选出来的科技领域50大影响力人物榜单，并且名列第10位。但是，类似的殿堂级位置，没有几个，不够大家分，没我们的事儿。
- 理论研究者。例如：八十年代李开复博士坚持采用隐含马尔可夫模型的框架，成功地开发了世界上第一个大词汇量连续语音识别系统Sphinx。可以说，这个工程也是相当出名的。
- 顶级产品成功。例如：微信的张小龙，当年开发的foxmail一度成为email的璀璨明珠，直到后来2012年使用foxmail改造出微信，横空出世，改变了世界，改变了人们的生活。他和乔布斯都是改变世界的那个人。
- 最佳实践。这个其实我们都可以做到，按照上面所提到的，在这条路上就如Rob大叔提到的“要想跑得远，先要走稳”。如果能做到这一点，就能在任何公司组建一支能打胜仗的技术团队，从而开发出高质量的软件系统。

从上面提到的几种人，可以看出，我们普通工程师提升自我的进化之路，其实就是不停地升级打怪、不断思考和打磨，才可以找到适合自己、适合团队的方法论以及落地生根的细节。

# code review有什么好处呢？
- 提升代码质量。如果将一个系统比作一个生命体，一行行代码比作一个个细胞，不好的设计宛如癌细胞，会逐渐扩散，终将杀死系统。而CR的过程就像是T细胞吞噬掉癌细胞，保证系统的健康成长。让系统有更长久的生命力。如果说，没有人Review的代码，其代码水准就是写代码人的水准，而被一个团队Review过的代码，它的水准将接近甚至超过整个团队的最高水准。
单个人可能在某些方便做的比较好，集大家之所长就能在各个方面都做的比较好。另外，随着CR流程日常化，每个参与人的编码能力也会逐步提升，无限趋近于团队最高水准，因为在CR的过程中，你可以看到别人做的好的地方，可以学习到经验，也可以看到别人做的不好的地方，吸取到教训。随着时间的流逝，逐渐积累为参与者的能力。
- 提前发现问题。有些团队在没有code review时，基本上都是过度依赖于测试，甚至是依赖于功能上线后用户暴露问题，这种发现方式已经偏晚了，尤其是让用户暴露问题的时候可能问题已经非常大了。可以说，问题暴露的越晚，风险也就越大。如果code review放在代码测试之前，就能在这个阶段发现问题，将各种风险扼杀在摇篮中。但是，code review真的能提前发现问题吗？如果能的话，可以提前发现什么样的问题？
其实，code review可以提前发现流程或者实现上的问题，尤其是在做业务需求的时候，不同工作经验的人对同一个需求的理解肯定会有差异，代码实现上也会有很大的差异，有时候一点点的理解偏差，导致出现那种失之毫厘谬以千里的后果，写代码的人也会因为处在自己的思维定式中发现不了问题，而别人可能因为经验丰富或者需求相关背景了解更多，就能很轻易发现问题。像这种情况一般出现在团队新人身上，他们对已有系统和业务了解不多，实现需求时很容易出现问题，这时候如果有人帮忙指出就能避免更严重的后果，另外也有助于新人了解业务和融入团队。
当我们在code review过程中，能够发现哪些是别人之前踩过的坑。例如：Java中SimpleDateFormat其实有线程安全的问题，或者说GO语言并非一种并发安全的语言，不了解的人很容易就踩坑了。如果别人踩过这个坑，就可以在code review过程中提前帮你指出来。很多开源的类库，甚至k8s或者etcd的项目中很多包或多或少都有使用上的坑，这种例子就数不胜数了。
- 经验和知识的传递。开发人员可以写出能运行的代码，但真正的工程师才能写出低bug、易扩展、易维护的高质量代码，更高级的工程师还能帮其他人成为一名合格的工程师。code review的流程也是高级工程师来帮助其他人最直接的方式。
当我们在code review中，可以看到其他人写出来的优秀代码、优秀的设计，甚至和改动相关的业务背景知识。当你review越多，学到的东西也就越多。另外，即便是哪些不太好的代码，经过别人的review，必然会留下很多评论或者是改动建议，甚至是别人之前踩的坑，你都能看到，从这些内容上你也可以学到很多新的知识。所以说，code review不仅仅是一个提升代码质量方式，它也可以肩负起知识积累和消息集散的功能。

# code review的步骤
- 需要了解改动的背景。
code review不是一上来就看代码，这样有可能你会看的云里雾里，纯粹是浪费时间。code review虽然是review代码，但是，首先你的知道你要看的代码实现了什么样的功能，是在什么样的背景下去做的，清楚前因后果之后。这样，你才能知道这个代码大概应该怎么去写，才能更好的去Review别人的代码、去发现别人的代码可能存在设计上的问题或者隐藏bug，或是安全漏洞等等。
- 需要纵观全局。
当你知道背景之后，在脑海中就会有一个大概的编码思路，也有个流程主线。这个时候可能有两种情况：你和写代码人的思路相同，那你就顺着你们共同的思路去帮忙Review整个流程是否正确。另一种情况就是：你们思路不同，你就得看代码去了解写作者的思路，然后确认是谁的思路有问题，或者是谁的思路更好，然后同写作者一起将这个流程优化到更优。
- 需要逐层细化。
确定完整个流程之后，就可以逐步深入到代码细节中了，细节可以Review的地方就很多了，可以看下下一节的内容，这里就先不展开了。等会，我会将结合具体的例子，详细讲解。

# code review该关注哪些点
在CR的过程中，如果有一些立足点的话可以帮助大家更好CR，核心的几个点如下：
- 功能性：代码所实现的功能是否和预期一样，是否实现了所有必须的功能？
- 复杂性：功能实现是否过于复杂？过于复杂的代码更容易出问题，而且可维护性也会更低。
- 代码风格：代码是否符合团队编码规范？
- 文档和相关注释：如果代码功能有改动，关注下相关文档和注释有没有同步改动。错误的注释和文档可能会让未来的开发者产生理解成本。
- 代码亮点：如果你看到变更中做得好的地方，也别吝啬你的赞美。
- 工程设计：代码架构设计、抽象设计、思维模式有哪些思考和权衡。

上面的内容，相对来说，描述更偏概括性，我们来举一些更详细的例子：
- 代码设计良好，可读性和可维护性高。
- 是否有线程安全的bug。
- 代码没有增加不必要的复杂性。
- 开发者没有写一些目前没有在用的代码，这种无用的代码未来大概率也不会用，所以不要假设。
- 代码有适当的单元测试。
- 测试逻辑设计良好。
- 开发者使用了清晰明了的变量和函数命名。
- 注释清晰明了且实用，并且解释清楚了为什么这么做，而不仅仅是做了啥。
- 代码有相应完善的文档。
- 代码风格符合规范。
- 代码有没有更优的实现？（性能、资源占用等情况）。
更多更细节的内容，可以参考：谷歌工程实践——代码评审 [https://github.com/xindoo/eng-practices-cn](https://github.com/xindoo/eng-practices-cn)

# code review的礼节
- 首先CR不是你个人炫技的舞台，看到别人代码的问题需要礼貌指出，切忌diss别人。
- 其次，CR不要为了提问题而提问题，有些代码就是没问题，你也没必要纠结必须要提个问题，直接通过即可。
- 这里在额外说一点，大部分review别人的代码，只关注到别人做的不好的地方，而忽视了别人做的好的地方，遇到好的代码、好的设计也别忘记点个赞。
- 别人提的CR应当及时处理，在很多公司中CR是开发流程中必要的一。没有Review通过的肯定是不能上线的。如果CR长时间不处理，可能会延误后续的流程。
- 最后，CR是相互的，今天你及时帮别人Review了，明天别人也会及时帮你Review。

# 如何写出对CR友好的代码呢？
程序写出来是给人看的，附带能在机器上运行————Harold Abelson。我们应该时刻谨记上面这句话。
- 提交前先做好自审。
提前自己处理掉一些低级错误，可以先借助一些工具完成一些简单的检查。例如：我们在GO语言的团队中，可以借助golint、goimports等工具完成代码风格和一些潜在bug的检查。然后，自己做好功能的自测，尽可能先消灭一部分bug，为CR减少一些负担。
- 写清楚变更描述。
这里对应上面提到的CR步骤中的了解改动背景，作为代码的写作者，你不能一上来就让别人从代码入手吧，可能看你代码的很多其他人都缺少代码改动相关的上下文信息，完全理解代码成本很高，所以需要在变更描述中将这些信息描述清楚，包括但不仅限于改动背景、改动点、流程、具体设计等等。一句话概括就是：好的变更描述应该说清楚这次是做了什么变更，以及为什么要这么做。
更详实的变更描述可以让Review代码人减少理解成本，更快完成CR的流程，你代码改动也就能更快进入后续流程了。
- 单个变更尽可能短。
一个非常大的变更几乎没有Review，因为大的改动首先就很难Review，其实也更耗费时间，还有出问题的概率也更大，谁Review通过了代码但之后上线出问题，可能是要和你一起背锅的。所以建议大家将大的代码变更尽可能拆小，因为小的变更有以下这些好处:
  - 代码评审更快。与比起花30分钟评审一个大的变更相比，对Review代码的人来说花5分钟审查一系列小的变更更加容易。
  - Review更加彻底。进行较大的更改后，审阅者和作者往往会因大量详细评论的来回移动而感到沮丧，有时这些评论会漏掉或遗漏重要的观点。
  - 减少导致bug的可能性。由于您所做的更改较少，因此您和您的审阅者更容易有效地推断出CL的影响，并查看是否导致bug。
  - 减少不必要的工作。当你写了一个巨大的变更，然后评审者觉得你总体方向错了，这会导致你浪费大量的工作。
  - 更方便合并代码。因为大型的变更会导致大量的冲突，因此合代码的时候会耗费很多时间，而且可能因合并代码导致问题，我们就出现过好几次代码合并的时候冲掉别人代码的情况。
  - 有助于你作出更好的设计。优雅的设计并且完善一个小的改动比大的改动更加容易。
  - 降低评审者的难度。提审部分改动，不会影响你继续编码。
  - 如果真出问题，回滚更容易。开发人员深有感触。
总的来说，对于那些很难拆分的变更，也不是需要完全禁止，有时候就是有改动非常大，而且无法再去拆分了，这时候还是建议通过其他方式来保证代码质量，比如全流程测试。然后也建议做好出问题时的快速恢复方案。
- 流程应该尽早提交。一般情况下，还是建议早点提交CR，并留出一定的时间来做修改，尽可能不要让这个流程变的匆忙。大部分公司的实践都是在进入测试流程的时候同时进入CR流程。

# 参考资料
- google代码规范: https://google.github.io/styleguide/go/index https://gocn.github.io/styleguide/
- uber go代码规范指南：https://github.com/uber-go/guide/blob/master/style.md#introduction https://github.com/xxjwxc/uber_go_guide_cn
